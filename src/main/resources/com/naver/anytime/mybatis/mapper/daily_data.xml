<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper
	namespace="com.naver.anytime.mybatis.mapper.DailyDataMapper">

	<select id="getDataTrend" resultType="DailyData">
		SELECT
		ROUND(1 - A.SCHOOLS / B.SCHOOLS, 2)*100 AS SCHOOL_RATIO, B.SCHOOLS SCHOOLS,
		ROUND(1 - A.POSTS / B.POSTS, 2)*100 AS POST_RATIO, B.POSTS POSTS,
		ROUND(1 - A.MEMBERS / B.MEMBERS, 2)*100 AS MEMBER_RATIO, B.MEMBERS
		MEMBERS
		FROM
		(SELECT SCHOOLS, POSTS, MEMBERS
		FROM DAILY_DATA
		WHERE TO_CHAR(DAY, 'YYYY-MM-DD') = TO_CHAR(SYSDATE - 2, 'YYYY-MM-DD')) A,
		(SELECT SCHOOLS, BOARDS, POSTS, MEMBERS
		FROM DAILY_DATA
		WHERE TO_CHAR(DAY, 'YYYY-MM-DD') = TO_CHAR(SYSDATE - 1, 'YYYY-MM-DD')) B
	</select>

	<select id="getRegistrationTrend" resultType="DailyData">
		SELECT TO_CHAR(DAY,'MM / DD') DAY_STRING,(MEMBERS - NEW_MEMBERS) PRE, NEW_MEMBERS, WITHDRAWN_MEMBERS
		FROM DAILY_DATA
		WHERE TO_CHAR(DAY,'YYYY-MM-DD') > TO_CHAR(SYSDATE-7,'YYYY-MM-DD')
		ORDER BY DAY_STRING ASC
	</select>

	<select id="getSchoolRanking" resultType="School">
		SELECT * FROM(
		SELECT S.NAME NAME, M.TOTAL_COUNT TOTAL_COUNT FROM SCHOOL S
		JOIN(
		SELECT SCHOOL_ID, COUNT(*) TOTAL_COUNT FROM MEMBER
		WHERE ACCOUNT_STATUS IS NOT NULL
		GROUP BY SCHOOL_ID) M
		ON S.SCHOOL_ID = M.SCHOOL_ID
		WHERE M.SCHOOL_ID != 1
		ORDER BY TOTAL_COUNT DESC)
		WHERE ROWNUM &lt;=5	
	</select>
	
	<select id="getBoardRanking" resultType="Board">
	    SELECT * FROM(
		SELECT S.NAME SCHOOL_NAME, B.NAME NAME, RK.NEW_POST NEW_POST FROM BOARD B
		JOIN
		(SELECT BOARD_ID , COUNT(*) NEW_POST FROM POST
		WHERE TO_CHAR(POST_DATE,'YYYY-MM-DD') > TO_CHAR(SYSDATE-1,'YYYY-MM-DD')
		GROUP BY BOARD_ID
		)RK
		ON B.BOARD_ID = RK.BOARD_ID
		JOIN SCHOOL S
		ON B.SCHOOL_ID = S.SCHOOL_ID
		WHERE B.SCHOOL_ID != 1
		ORDER BY NEW_POST DESC)
		WHERE ROWNUM &lt;=5	
	</select>
	
	<select id="getTodoList" resultType="DailyData">
		SELECT
		  NVL(BOARD.TO_DO_BOARD, 0) AS TO_DO_BOARD,
		  NVL(BOARD.DONE_BOARD, 0) AS DONE_BOARD,
		  NVL(BOARD_PERCENT,0) AS BOARD_PERCENT,
		  NVL(REPORT.TO_DO_REPORT, 0) AS TO_DO_REPORT,
		  NVL(REPORT.DONE_REPORT, 0) AS DONE_REPORT,
		  NVL(REPORT_PERCENT,0) AS REPORT_PERCENT
		FROM (
		  SELECT
		    NVL(DO.CNT, 0) AS TO_DO_BOARD,
		    NVL(DONE.CNT, 0) AS DONE_BOARD,
		     CASE
		        WHEN NVL(DO.CNT, 0) = 0 THEN 0
		        ELSE (NVL(DONE.CNT, 0) / NVL(DO.CNT, 0)) * 100
		     END AS BOARD_PERCENT
		  FROM (
		    SELECT COUNT(*) AS CNT
		    FROM BOARD
		    WHERE (TYPE = 2 OR TYPE = 3)
		      AND STATUS = 0
		      AND REJECT_REASON IS NULL
		  ) DO, 
		  (
		    SELECT COUNT(*) AS CNT
		    FROM BOARD
		    WHERE (TYPE = 2 OR TYPE = 3)
		      AND (STATUS = 3 OR STATUS = 4)
		  ) DONE
		) BOARD,
		(
		  SELECT
		    NVL(DO.CNT, 0) AS TO_DO_REPORT,
		    NVL(DONE.CNT, 0) AS DONE_REPORT,
		     CASE
		        WHEN NVL(DO.CNT, 0) = 0 THEN 0
		        ELSE (NVL(DONE.CNT, 0) / NVL(DO.CNT, 0)) * 100
		     END AS REPORT_PERCENT
		  FROM (
		   SELECT COUNT(*) CNT FROM REPORT
		  WHERE ACTION_DATE IS NULL OR TO_CHAR(ACTION_DATE,'YYYY-MM-DD')= TO_CHAR(SYSDATE,'YYYY-MM-DD')
		  ) DO, 
		  (
		   SELECT COUNT(*) CNT FROM REPORT
		  WHERE TO_CHAR(ACTION_DATE,'YYYY-MM-DD') = TO_CHAR(SYSDATE,'YYYY-MM-DD')
		  ) DONE
		) REPORT
	</select>
	
	<insert id="insertDailyData">
		 INSERT INTO DAILY_DATA
		  (DAY, SCHOOLS, MEMBERS, BOARDS, POSTS, NEW_MEMBERS, WITHDRAWN_MEMBERS)
		  VALUES
		  (SYSDATE - 1, 
		   (SELECT COUNT(*) FROM SCHOOL), 
		   (SELECT COUNT(*) FROM MEMBER WHERE ACCOUNT_STATUS != 0), 
		   (SELECT COUNT(*) FROM BOARD WHERE STATUS != 0),
		   (SELECT COUNT(*) FROM POST WHERE STATUS != 0), 
		   0, 
		   0)
	</insert>
</mapper>